#!/bin/bash -e

# uncomment to get command tracing from bash
# set -x

VAULT_INSTALL="$(dirname $0)/.."
VAULT_LIB="$VAULT_INSTALL/lib"

shopt -s expand_aliases
unalias -a # make sure nothing already loaded

source $VAULT_LIB/functions.sh
source $VAULT_LIB/prerequisites.sh
source $VAULT_LIB/aliases.sh

true ${VAULT_ROOT:="$HOME/.vault"}
mkdir -p "$VAULT_ROOT/repos"

CMD="$1"
shift

load_config

case $CMD in
  init)
    set_remote "$1"
    init
    ;;
  clone)
    set_remote "$1"
    clone
    ;;
  checkout)
    assert_config
    checkout
    ;;
  push)
    assert_config
    push # push the shadow repo to the remote
    clean
    ;;
  fetch)
    assert_config
    pushd $VAULT_REPO
    git fetch
    popd
    ;;
  pull)
    assert_config
    pull
    ;;
  clean)
    assert_config
    push # defensive push to make sure we don't throw away any changes
    clean
    ;;
  *)
    usage
    ;;
esac
