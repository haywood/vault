#!/bin/bash -e

# uncomment to get command tracing from bash
# set -x

VAULT_INSTALL="$(dirname $0)/.."
VAULT_LIB="$VAULT_INSTALL/lib"
VAULT_WORK_SPACE="$(mktemp -d -t vault-work-space)"
VAULT_WORK_TREE="$VAULT_WORK_SPACE/work-tree"
mkdir -p "$VAULT_WORK_TREE"
trap "rm -rf $VAULT_WORK_SPACE" EXIT

shopt -s expand_aliases
unalias -a # make sure nothing already loaded

source $VAULT_LIB/functions.sh
source $VAULT_LIB/prerequisites.sh
source $VAULT_LIB/aliases.sh

CMD="$1"
shift

set_repo

case $CMD in
  init)
    REMOTE="$1"
    true ${REMOTE:?Remote is required}
    init
    ;;
  clone)
    REMOTE="$1"
    true ${REMOTE:?Remote is required}
    clone
    ;;
  checkout)
    load_config
    checkout
    ;;
  push)
    load_config
    push # push the shadow repo to the remote
    clean
    ;;
  fetch)
    load_config
    # TODO this should fetch from the remote, decrypt,
    # and then fetch from the managed git repo
    # the resultant fetch function should then be used
    # as part of the pull implementation
    vault fetch
    ;;
  pull)
    load_config
    pull
    ;;
  clean)
    load_config
    push # defensive push to make sure we don't throw away any changes
    clean
    ;;
  *)
    usage
    ;;
esac
